name: DotMe9 - Part B Full App Files

on:
  workflow_dispatch:

jobs:
  build_files:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Create full Android app files
      run: |
        set -euo pipefail

        # Ensure folders
        mkdir -p app/src/main/java/com/dotme9/app
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/assets

        # ---------- Manifest ----------
        cat > app/src/main/AndroidManifest.xml <<'MAN'
<manifest package="com.dotme9.app"
    xmlns:android="http://schemas.android.com/apk/res/android">

    <uses-permission android:name="android.permission.INTERNET" />

    <application
        android:label="DotMe9"
        android:allowBackup="true">
        <activity android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>

        <service
            android:name=".SimpleVpnService"
            android:permission="android.permission.BIND_VPN_SERVICE"
            android:exported="false"/>
    </application>

</manifest>
MAN

        # ---------- build.gradle (app) ----------
        cat > app/build.gradle <<'APP'
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

android {
    compileSdk 34

    defaultConfig {
        applicationId "com.dotme9.app"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        debug { applicationIdSuffix ".debug" }
        release { minifyEnabled false }
    }
    namespace "com.dotme9.app"
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.10"
    implementation "androidx.core:core-ktx:1.12.0"
    implementation "androidx.appcompat:appcompat:1.7.0"
    implementation "com.google.android.material:material:1.9.0"
}
APP

        # ---------- MainActivity ----------
        cat > app/src/main/java/com/dotme9/app/MainActivity.kt <<'KT'
package com.dotme9.app

import android.content.Intent
import android.net.VpnService
import android.os.Bundle
import android.widget.Button
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {

    private val VPN_REQUEST_CODE = 200

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        val btnToggle = findViewById<Button>(R.id.btnToggle)
        val tvCount = findViewById<TextView>(R.id.tvCount)

        HostsManager.load(applicationContext)
        tvCount.text = "Blocked today: ${HostsManager.getBlockedCount(applicationContext)}"

        btnToggle.setOnClickListener {
            val vpnPrepare = VpnService.prepare(this)
            if (vpnPrepare != null) startActivityForResult(vpnPrepare, VPN_REQUEST_CODE)
            else startService(Intent(this, SimpleVpnService::class.java))
        }
    }
}
KT

        # ---------- SimpleVpnService ----------
        cat > app/src/main/java/com/dotme9/app/SimpleVpnService.kt <<'KT'
package com.dotme9.app

import android.net.VpnService
import android.os.ParcelFileDescriptor
import kotlin.concurrent.thread
import java.io.FileInputStream

class SimpleVpnService : VpnService() {

    private var vpnInterface: ParcelFileDescriptor? = null
    @Volatile private var running = false

    override fun onStartCommand(intent: android.content.Intent?, flags: Int, startId: Int): Int {
        HostsManager.load(applicationContext)
        startVpn()
        return START_STICKY
    }

    private fun startVpn() {
        val builder = Builder()
            .setSession("DotMe9")
            .addAddress("10.0.0.2", 32)
            .addRoute("0.0.0.0", 0)
            .addDnsServer("1.1.1.1")

        vpnInterface = builder.establish()
        running = true

        vpnInterface?.let { pfd ->
            thread {
                val input = FileInputStream(pfd.fileDescriptor)
                val packet = ByteArray(32767)

                while (running) {
                    val len = input.read(packet)
                    if (len > 0) {
                        val payload = String(packet, 0, len)
                        if (HostsManager.isBlockedPacket(payload)) {
                            HostsManager.incrementBlockedCount(applicationContext)
                        }
                    }
                }
            }
        }
    }
}
KT

        # ---------- HostsManager ----------
        cat > app/src/main/java/com/dotme9/app/HostsManager.kt <<'KT'
package com.dotme9.app

import android.content.Context
import java.io.BufferedReader
import java.io.InputStreamReader

object HostsManager {
    private val blocked = HashSet<String>()
    private const val PREFS = "dotme9"
    private const val KEY_COUNT = "blocked_today"

    fun load(context: Context) {
        if (blocked.isNotEmpty()) return

        val reader = BufferedReader(InputStreamReader(context.assets.open("hosts.txt")))
        while (true) {
            val line = reader.readLine() ?: break
            val clean = line.trim()
            if (clean.isNotEmpty() && !clean.startsWith("#"))
                blocked.add(clean)
        }
        reader.close()
    }

    fun isBlockedPacket(payload: String): Boolean {
        for (host in blocked) if (payload.contains(host, ignoreCase = true)) return true
        return false
    }

    fun incrementBlockedCount(context: Context) {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        val newValue = prefs.getInt(KEY_COUNT, 0) + 1
        prefs.edit().putInt(KEY_COUNT, newValue).apply()
    }

    fun getBlockedCount(context: Context): Int {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        return prefs.getInt(KEY_COUNT, 0)
    }
}
KT

        # ---------- layout ----------
        cat > app/src/main/res/layout/activity_main.xml <<'XML'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:padding="24dp"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <Button
        android:id="@+id/btnToggle"
        android:text="Start VPN"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>

    <TextView
        android:id="@+id/tvCount"
        android:text="Blocked today: 0"
        android:layout_marginTop="20dp"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
</LinearLayout>
XML

        # ---------- hosts (basic) ----------
        cat > app/src/main/assets/hosts.txt <<'HOST'
ads.example.com
g.doubleclick.net
ads.youtube.com
HOST

    - name: Commit files
      run: |
        git config user.email 'actions@github.com'
        git config user.name 'GitHub Actions'
        git add .
        git commit -m 'Part B: Full app files added' || echo "No changes"
        git push
